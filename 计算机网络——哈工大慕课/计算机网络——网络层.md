# 计算机网络——网络层

## 1. 概述

网络层核心功能：转发与路由，连接建立（可选）

转发：将分组从路由器的输入端口转移到合适的输出端口，路由器中的转发表确定本路由如何转发分组

路由：确定分组从源到目的经过的路径，路由算法确定通过网络的端到端的路径

网络层的连接是主机到主机的连接，确定的是连接的路径

**网络层服务模型：**

无连接服务

* 不事先为系列分组的传输确定传输路径


* 每个分组独立确定传输路径，根据当前网络的状态选择路径
* 不同分组可能传输路径不同
* **数据报网络（datagram network）**

连接服务

* 首先为系列分组的传输确定从源到目的经过的路径
* 然后沿该路径传输系列分组
* 系列分组传输路径相同
* 传输结束后拆除连接
* **虚电路网络**


数据报网络和虚电路网络是典型的两类分组交换网络

网络层的连接服务和传输层的连接服务的本质区别：

> 网络层提供的连接服务是主机到主机的连接服务，最关键的是在网络核心实现，传输层是端到端的连接，在网络边缘

### 1.1 虚电路网络

虚电路：一条从源主机到目的主机，类似于电路的路径（逻辑连接），与电路交换里面的路径的区别在于

* 虚电路网络是分组交换
* 每个分组的传输利用链路的全部带宽（电路交换会频分，时分等）
* 源到目的路径经过的网络层设备共同完成虚电路网络功能

通信过程：呼叫建立-》数据传输-》拆除呼叫，每个分组携带虚电路标识，而不是目的主机地址 ，虚电路经过的每个网络设备（如路由器），维护每条经过它的虚电路连接状态

每条虚电路包括：

1. 从源主机到目的主机的一条路径，途中的网络设备需要参与这条连接的维护
2. 虚电路号（VCID），沿路每段链路一个编号
3. 沿路每个网络层设备，利用转发表记录经过的每条虚电路

沿某条虚电路传输的分组，携带对应虚电路的VCID，而不是目的地址，所以同一条VC，在每段链路上的VCID通常不同，路由器转发分组时依据转发表改写/替换虚电路号

VC转发表示例：

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170504/170646895.png)

> VC路径上每个路由器都需要维护VC连接的状态信息，包括建立维护和拆除

**虚电路信令协议：**

* 用户VC的建立、维护、与拆除：路径选择.
* 应用于虚电路网络：如ATM、帧中继网络等
* 目前的Internet网络不采用

### 1.2 数据报网络

数据报网络的特点：

* 网络层无连接
* 每个分组携带目的地址
* 路由器根据分组的目的地址转发分组：
  * 基于路由协议/算法构建转发表
  * 检索转发表
  * 每个分组独立选路

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170504/184826578.png)

聚合转发，具有相同字段的目的地址走同一个链路接口，匹配的时候最长前缀匹配优先原则

**数据报网络和VC网络的对比：**

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170506/134458693.png)

## 2. Internet网络层——IP协议

主机、路由器网络层主要功能：路由和转发

路由协议：路径选择，RIP,OSPF,BGP，路由的信息存储在转发表上，供网络层的协议在转发或者处理数据分组时使用

IP协议：

* 寻址规约
* 数据报格式
* 分组处理规约

IPv4数据报格式如下

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170506/135829268.png)

首部长度字段占4位：IP分组首部长度，以4个字节为单位，所以首部长度位一般：5H

服务类型字段占8位：只有在网络提供区分服务时使用，一般情况下不使用，一般00H

总长度字段占16位：IP分组的总字节数（首部加数据）

* 最大的IP分组的总长度：65535B
* 最小的IP分组首部：20B
* IP分组可以封装的最大数据：65515B

生存时间（TTL：time to live）字段占8位：IP分组在网络中可以通过的路由器数（跳步数），路由器转发一起TTL减一，TTL=0时会丢弃该分组

协议字段占8位：指示IP分组封装的是哪个协议的数据包，实现复用/分解，6表示TCP，17表示UDP

首部校验和字段占16位：实现对IP分组首部的差错检测，求和（溢出回卷）反码得到校验和

选型字段占长度可变，范围在1-40B之间：携带安全、源选路径、时间戳和路由记录等内容，不常用

### 2.1 IP分片

最大传输单元(MTU)：网路链路存在MTU，链路层数据帧可封装数据的上限，而且不同链路中的MTU是不一样的

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170506/151314536.png)

当一个大的IP分组向一个较小MTU链路转发的时候，可以进行分片操作

* 一个IP分组分为多片IP分组fragmented
* IP分片到达目的主机后进行“重组”（路由器只分不装，目的主机装）reassembled
* IP首部相关字段用于标识分片以及确定分片的相对顺序

分片操作和首部字段中的标识、标志位、以及片偏移字段相关

标志ID：16位，每次加一，与源IP目的IP以及协议一起唯一标志一个IP分组

标志位：3位，第一位保留，第二位DF（1：禁止分片，0：允许分片），第三位MF（1：非最后一片，0：最后一片或未分片）

那么到底如何判断是分片的最后一片还是未分片呢？

片偏移：13位，一个IP分组分片封装原IP分组数据的相对偏移量（从原IP分组的哪一个字节开始封装），片偏移量为0并且MF为0，则一定是未分片，片偏移字段是以8个字节为单位

**IP分片过程：**

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170506/154123907.png)

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170506/154316140.png)

一个例题：

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170506/154511067.png)

### 2.2 IP编址

IP地址：32bit，编号标识主机、路由器的接口，IP地址与每个接口关联（实现了网络层功能的）

由两部分组成：网络号（高位）+主机号（低位），要保证一个网络区域内的网络号是相同的

IP子网：IP地址具有相同网络号的设备接口，不跨越路由器可以彼此物理联通的接口

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170506/160556701.png)

图中跨越了路由器的网络不属于一个子网

### 2.3 有类IP地址

A类地址：0.0.0.0~127.255.255.255    占据50%   网络号前8位（0xxxxxxx），后24位是主机号

B类地址：128.0.0.0~191.255.255.255 占据25%  前16个bit作为网络号(10xxxxxx xxxxxxxx)，后16个bit作为主机号

C类地址：192.0.0.0~223.255.255.255  占据12.5% 网络号：前24位（110xx...）后8位作为主机号

D类地址： 224.0.0.0 ~ 239.255.255.255 占据6.25%  1110xxxx

E类地址： 240.0.0.0~255.255.255.255 占据6.25% 1111xxxx

**特殊IP地址：**

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170508/151302772.png)

**私有IP地址：**

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170508/151621056.png)

### 2.4 IP子网划分与子网掩码

IP子网划分：将原来IP地址中的主机号的**部分比特位**进行子网划分

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170508/160032226.png)

> 如何确定是否划分了子网？利用了多少位划分了子网？——子网掩码

**子网掩码：**

* 形如IP地址，32位
* NetID和SubID位全取1，HostID位全部取0
* A网的默认子网掩码为：255.0.0.0  B：255.255.0.0  C：255.255.255.0
* 借用3个bit划分子网的B网的子网掩码为：255.255.224.0

对于B网默认子网掩码：FFH.FFH.00H.00H，借用3位：FFH.FFH.11100000.00H

所以就是255.255.224.0

同理：对于C网：201.2.3.0划分4个等长的子网，借用两个bit，子网掩码为：255.255.255.192

**子网掩码的应用：**

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170508/222429361.png)

子网划分会造成一定的IP地址的浪费或者损失，因为主机位全部为0的是网络地址，全部为1的是直接广播地址

**CIDR与路由聚集**

因特网的地址分配策略被称为无类别域间路由选择（classless interdomain routing）

对于子网寻址，32比特IP地被划分为两部分，形式为：a.b.c.d/x，其中x指示了地址的第一部分的比特数

* 消除传统按类分址的界限，网络前缀可以任意长度
* 融合子网地址和子网掩码，方便子网划分
* 可以路由聚集，构造超网

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170518/162753238.png)

### 2.5 DHCP协议

一个主机获取IP地址有两种方式：

1. 静态配置：IP地址，子网掩码，默认网关，DNS域名解析服务器
2. 动态主机配置协议DHCP，即插即用，自动获取

一个新的主机申请IP地址的过程：

* **DHCP发现报文**   客户端在UDP分组中向端口67发送该发现报文，以0.0.0.0作为源地址，使用广播目的地址255.255.255.255，将该IP报文传送给链路层
* **DHCP提供报文**    子网中收到发现报文的DHCP服务器（可能有多个），使用广播目的地址发一个提供报文，包含：发现报文的事务ID，向客户端推荐的IP地址以及IP地址租用期
* **DHCP请求**   客户端可能会收到多个DHCP服务器的提供报文，此时选择一个，并向选择的服务器提供一个DHCP请求报文进行响应，回显配置参数，此时依旧是通过广播的形式（可以拒绝其他的DHC服务器）
* **DHCP ACK**    包括分配给客户机的IP地址，子网掩码，默认网关以及DNS服务器地址

