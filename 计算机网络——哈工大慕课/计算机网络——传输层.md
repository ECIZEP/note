# 计算机网络——传输层

## 1. 传输层概述

传输层协议为运行在不同Host上的进程提供了一种逻辑通信机制，此层的消息会被处理或解包成一个个的`Segment`，同时传输层为应用层提供了两种协议`TCP`与`UDP`

**传输层和网络层：**

网络层提供的是主机之间的逻辑通信机制，传输层提供应用进程之间的逻辑通信机制，位于网络层之上依赖网络层服务

**Internet传输层协议：**

* TCP：拥塞控制，流量控制，连接建立，可靠按序的交付服务
* UDP：不可靠的交付服务
* 两种服务都不保证延迟和带宽
* 运输层协议的最低限度是必须提供一种复用和分解的服务

## 2. 多路复用和多路分用

**多路分用**：传输层根据头部信息将受到的`Segment`交给正确的`socket`，即不同的进程

**多路复用**：从多个`socket`接受数据，为每个数据封装上头部信息，生成`segment`，交给网络层

那么分用时如何工作的呢？

* 每个传输层的数据报都携带源IP地址和目的IP地址
* 每个数据报携带一个传输层的段
* 每个段携带源端口号和目的端口号

多路复用如何工作：

* 传输层协议提取IP地址和端口号信息，将`segment`导向相应的`socket`

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170308/134319388.png)

### 2.1 无连接的多路复用与多路分解

无连接的多路分用UDP，大致过程如下：

1. 利用端口号创建Socket
2. UDP的Socket用二元组标识，目的IP地址与端口 
3. 主机收到UDP段后，检查段中的目的端口号，把UDP段导向绑定在该端口号的Socket 
4. 具有相同二元组标识的报文段将被送到相同的进程

那么，标识中的源端口号有什么作用呢?

源端口号作为“返回地址”的一部分，当主机接受到客户机的消息后，如果需要给客户机发消息响应，则可以从客户机发来的报文段从取值获取客户机的端口

### 2.2 面向连接的多路复用与多路分解

面向连接的多路分用TCP，大致过程如下：

1. 创建TCP的Socket，一个四元组标识，源IP地址和目的IP地址，源端口号和目的端口号
2. 接收端利用所有的四个值将`segment`导向合适的Socket
3. 服务器可能同时支持多个TCP的socket，每个socket都有自己的四元组标识
4. web服务器为每个客户端开不同的socket进程

分解时主机会使用全部4个标识来定向分解到相应的套接字，如果有不同源IP和源端口号的TCP报文段，则会被分解到不同的套接字，只有四个值全部匹配，才会分解到之前创建的套接字中，如果不存在则会新建TCP套接字

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170308/142305620.png)

## 3. 无连接运输——UDP

RFC768定义的UDP只是做了运输层协议能够做的做少的工作，除了复用和分解以及少量的差错检测之外，它几乎没有对IP增加别的东西，实际上UDP编程，基本就是直接和IP打交道。

DNS就是一个使用UDP协议的例子，DNS应用程序进行一次查询时，它够着了一个DNS查询的报文并交给UDP，无须做其他任何工作，UDP为此报文添加首部字段然后将形成的报文段发送给网络层，网络层将这个UDP报文段封装进一个IP数据报中，然后将其发送给一个服务器，等待响应，如果没有收到响应，则会试图给另一个DNS服务器发送

那么，为什么对于有些应用宁愿在UDP上构建应用也不再TCP上构建应用呢？主要原因有以下几点

* **关于何时、发送什么数据使用UDP应用层可以控制的更加精细**——只要应用将数据传递给UDP，UDP就会将数据打包进UDP报文段并立即传递给网路层，而在另一方面，TCP有一个拥塞机制，可能会有延迟，所以对于一些实时性要求较高的应用，会使用UDP
* **无需建立连接**——典型如TCP，在数据传输开始之前，需要进行三次握手，UDP却不需要进行任何准备就可以开始传输数据，因此UDP不会有建立连接的时延，这也是为什么DNS会架构在UDP上的原因，而HTTP架设在TCP之上，是因为网页传输必须要有可靠性，数据不能丢
* **无连接状态**——TCP需要再端系统中维护连接状态，此连接状态包括接受和发送缓存、拥塞控制参数以及序号和确认号的参数，而UDP不需要维护连接，也不会跟踪这些参数
* **分组首部开销小**——每个TCP报文都有20字节的首部开销，而UDP仅有8个字节的开销（其中源端口和目的短端口占四个字节）

对于UDP传输的缺点，数据传输不可靠容易丢失，但是可以将可靠性构建在应用中——建立一些确认以及重传机制

### 3.1 UDP报文结构

一共8个字节，源和目的端口号占用四个字节，长度和检验和占四个字节

* 长度：指示了UDP报文段中的字节数（首部信息+数据）
* 检验和：接收方利用这个来检验数据是否出了差错

![mark](http://ogzrgstml.bkt.clouddn.com/blog/20170308/150509493.png)

**UDP检验和：**

发送方的UDP对报文段中的所有的16比特字的和进行反码运算，求和时遇到任何溢出都被回卷，得到的结果被放在检验和字段，在接收方，就会把全部的4个16比特字加在一起，如果没有差错，那么结果就是1111111111111111，否则只要有一位是0，那么传输就有问题

回卷：首部溢出的1加到最低位，（1）0100101011000001，回卷就是0100101011000001+1=0100101011000010

### 3.2 可靠数据传输原理

